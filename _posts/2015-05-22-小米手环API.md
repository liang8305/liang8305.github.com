---
layout : post
categories: [其他]
tags : [反编译, 小米手环, API, SDK]
keywords : 
excerpt: 
---
{% include JB/setup %}

上篇文章[通过leScan获取rssi实现蓝牙测距](/其他/通过leScan获取rssi实现蓝牙测距.html), 利用这个可以做很多好玩的东西, 比如手机防丢. 那这样当手机和手环离开一定距离时, 手机和手环都发出警报.

手机的好做, 发出声音, 震动, 什么的; 但是手环想要震动, 小米没有给API啊

好吧, 非暴力不合作. 

下载`小米运动_1.4.641_1058.apk`, 然后利用[apk_hack](https://github.com/pangliang/apk_hack.git) :

```bash
./decompile_apk.sh 小米运动_1.4.641_1058.apk
```

导入到eclipse 进行debug... 

eclipse崩溃? 难道这个app还做了反反编译, 反debug? 不至于吧? 各种google, 后来发现, 每次debug, eclipse右下角的内存显示都不停涨, 涨涨到512m就挂了; 好吧, 想起来eclipse的最大内存是512m, 估计是这个编译要太多内存了

修改eclipse目录下的`eclipse.ini`文件中的`-Xmx`参数到2048m; 正常运行了, 看到最大内存跳到700多m

好了, 正常debug了, 发现每次按查找手环, debug都会打印出:

```
05-22 20:07:31.878: D/BluetoothGatt(20195): writeCharacteristic() - uuid: 0000ff05-0000-1000-8000-00805f9b34fb
05-22 20:07:32.528: D/BluetoothGatt(20195): onCharacteristicWrite() - Device=88:0F:10:80:A2:4A UUID=0000ff05-0000-1000-8000-00805f9b34fb Status=0
05-22 20:07:32.533: D/BluetoothGatt(20195): readCharacteristic() - uuid: 0000ff0c-0000-1000-8000-00805f9b34fb
05-22 20:07:32.538: D/BluetoothGatt(20195): onNotify() - Device=88:0F:10:80:A2:4A UUID=0000ff03-0000-1000-8000-00805f9b34fb
05-22 20:07:33.773: D/BluetoothGatt(20195): onCharacteristicRead() - Device=88:0F:10:80:A2:4A UUID=0000ff0c-0000-1000-8000-00805f9b34fb Status=0
```

哦? `BluetoothGatt`, google下, 这个是低功耗蓝牙的连接方式, 简单说就是每个硬件设备会包含很多`服务`, 不同的服务按照`UUID`来区分. 也就是说, 现在这个`让手环震动`是通过`UUID=0000ff05-0000-1000-8000-00805f9b34fb` 这个服务进行的

然后顺着这个UUID, google到了下面这些:

- [Get handle values from MILI service charcteristics](https://bitbucket.org/OscarAcena/mibanda/issue/5/get-handle-values-from-mili-service)
- [xiaomi-miband-android](https://github.com/paulgavrikov/xiaomi-miband-android)
- [xiaomi-mi-band-ble-protocol](http://allmydroids.blogspot.de/2014/12/xiaomi-mi-band-ble-protocol-reverse.html)


好了, 知道了蓝牙android的使用方式, 也知道了手环的各个UUID, 那写入到`Characteristic`特征里的value是啥? 在`BluetoothGatt.writeCharacteristic()`继续下个断点, 好了, 写入的的是`{0x8,0x0}`; 在`xiaomi-mi-band-ble-protocol`这个文章里已经收集了不少了

ok,写个程序试试:
















